generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id               String  @id @default(uuid())
  name             String
  location         String?
  timezone         String?
  phoneNumber      String? @unique

  // Customization & Subscription
  plan             String  @default("Basic")
  brandColor       String  @default("#000000")
  logoUrl          String?
  aiName           String  @default("ScriptishRx AI")
  aiWelcomeMessage String?
  customSystemPrompt String?
  integrations     String?

  // Communication & AI Configuration
  twilioConfig     Json?   // Stores: { accountSid, authToken, phoneNumber, voiceSettings: {...} }
  aiConfig         Json?   // Stores: { model, temperature, systemPrompt, voiceId, welcomeMessage }
  
  // Deprecated (Migrate to aiConfig)
  voiceCakeAgentId String? @ignore

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users            User[]
  clients          Client[]
  bookings         Booking[]
  minutes          MeetingMinute[]
  messages         Message[]
  workflows        Workflow[]
  campaigns        Campaign[]
  invites          Invite[]
  callSessions     CallSession[]
  customTools      CustomTool[]

  @@index([name])
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  password     String
  name         String?
  role         String  @default("MEMBER") // SUPER_ADMIN, ADMIN, MEMBER
  
  // RBAC Fields
  roleId       String?
  definedRole  Role?   @relation(fields: [roleId], references: [id])

  tenantId     String
  tenant       Tenant  @relation(fields: [tenantId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  subscription Subscription?
  avatarUrl    String?
  phoneNumber  String?
  notifications Notification[]
  transactions Transaction[]
  // Google Calendar integration fields
  googleAccessToken   String? @db.Text
  googleRefreshToken  String? @db.Text
  googleTokenExpiry   BigInt?

  @@index([tenantId])
  @@index([email])
  @@index([role])
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique // SUPER_ADMIN, OWNER, ADMIN, MEMBER, SUBSCRIBER
  description String?
  isSystem    Boolean      @default(false)
  users       User[]
  permissions Permission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   // e.g. clients, settings
  action      String   // e.g. create, read
  description String?
  roles       Role[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([resource, action])
}

model Client {
  id        String  @id @default(uuid())
  name      String
  phone     String?
  email     String?
  notes     String?
  source    String  @default("Direct")
  tenantId  String
  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bookings  Booking[]
  minutes   MeetingMinute[]
  callSessions CallSession[]

  @@index([tenantId])
  @@index([phone])
  @@index([email])
}

model Booking {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  date      DateTime
  status    String   @default("Scheduled")
  purpose   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([clientId])
  @@index([date])
  @@index([status])
}

model MeetingMinute {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([clientId])
}

model Message {
  id            String       @id @default(uuid())
  sessionId     String
  role          String
  content       String
  tenantId      String?
  tenant        Tenant?      @relation(fields: [tenantId], references: [id])
  userId        String?
  source        String       @default("chat") // chat, voice, sms
  callSessionId String?
  callSession   CallSession? @relation(fields: [callSessionId], references: [id])
  createdAt     DateTime     @default(now())

  @@index([sessionId])
  @@index([tenantId])
  @@index([callSessionId])
}

model CallSession {
  id           String    @id @default(uuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  clientId     String?
  client       Client?   @relation(fields: [clientId], references: [id])
  callSid      String    @unique // Twilio Call SID
  callerPhone  String?
  status       String    @default("in_progress") // in_progress, completed, failed
  direction    String    @default("inbound") // inbound, outbound
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  duration     Int?      // Duration in seconds
  transcript   String?   // Full conversation transcript
  summary      String?   // AI-generated summary
  actionItems  Json?     // Extracted action items [{type, description, completed}]
  bookingId    String?   // If a booking was created during call
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  messages     Message[]

  @@index([tenantId])
  @@index([clientId])
  @@index([callSid])
  @@index([callerPhone])
}

model Subscription {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id])
  
  // Core Fields
  type             String   @default("INDIVIDUAL") // INDIVIDUAL, ORGANIZATION
  plan             String   // Basic, Intermediate, Advanced
  status           String   // active, trial, canceled, expired
  billingCycle     String   @default("monthly") // monthly, yearly
  
  // Payment Links
  stripeId         String?  // Legacy
  paypalId         String?  // Legacy
  paymentReference String?  // Active Payment Ref (Paystack/Stripe)
  
  startDate        DateTime @default(now())
  endDate          DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Workflow {
  id        String   @id @default(uuid())
  name      String
  trigger   String
  actions   String
  isActive  Boolean  @default(true)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  isRead    Boolean  @default(false)
  type      String
  link      String?
  createdAt DateTime @default(now())

  @@index([userId])
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String
  details    String?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([tenantId])
}

model Campaign {
  id         String   @id @default(uuid())
  name       String
  type       String
  status     String
  sentCount  Int      @default(0)
  openCount  Int      @default(0)
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([tenantId])
}

model Invite {
  id         String    @id @default(uuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email      String
  role       String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdBy  String
  createdAt  DateTime  @default(now())

  @@index([token])
  @@index([email])
  @@index([tenantId])
}

// Custom Function Calling Tools for Voice/Chat Agents
model CustomTool {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String   // Function name: e.g., "check_inventory", "schedule_pickup"
  displayName String?  // Human-readable name for UI
  description String   // Description for OpenAI function calling
  
  // OpenAI Function Parameters Schema (JSON Schema format)
  parameters  Json     // { type: "object", properties: {...}, required: [...] }
  
  // Execution Configuration
  handlerType String   @default("webhook") // webhook, internal, api
  webhookUrl  String?  // URL to call for webhook handlers
  apiConfig   Json?    // For api handlers: { endpoint, method, headers, bodyTemplate }
  internalHandler String? // For internal: built-in handler name
  
  // Settings
  isActive    Boolean  @default(true)
  timeout     Int      @default(10000) // Timeout in ms
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isActive])
}

model Transaction {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  reference   String   @unique // Paystack Reference
  amount      Int      // In kobo
  currency    String   @default("NGN")
  status      String   // INITIATED, SUCCESS, FAILED, ABANDONED
  plan        String?
  metadata    Json?
  errorMessage String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  paidAt      DateTime?

  @@index([userId])
  @@index([status])
}